version: 2.1

orbs:
  windows: circleci/windows@2.4.0

jobs:
  sdist:
    docker:
      - image: python:3.8
    steps:
      - checkout
      - run:
          name: Build
          command: |
            python -m pip install --quiet --upgrade pip
            python -m pip install --quiet --upgrade pep517
            python -m pep517.build --source --out-dir dist/ .
      - store_artifacts:
          path: dist/
      - persist_to_workspace:
          root: .
          paths:
            - dist/
  bdist:
    docker:
      - image: python:3.8
    steps:
      - checkout
      - run:
          name: Build
          command: |
            python -m pip install --quiet --upgrade pip
            python -m pip install --quiet --upgrade pep517
            python -m pep517.build --binary --out-dir dist/ .
      - store_artifacts:
          path: dist/
      - persist_to_workspace:
          root: .
          paths:
            - dist/
  tox_typehints_linux_cpython_3_8:
    docker:
      - image: python:3.8
    environment:
      TOXENV: typehints
    steps:
      - checkout
      - run:
          name: Tox
          command: |
            python -m pip install --quiet --upgrade pip setuptools wheel
            python -m pip install tox
            python -m tox
      - store_artifacts:
          path: dist/
  tox_linux_cpython_3_6_bdist:
    docker:
      - image: python:3.6
    environment:
      TOXENV: py36
    steps:
      - checkout
      - attach_workspace:
          at: .
      - run:
          name: Select distribution file
          command: |
            ls ${PWD}/dist/*
            echo "export DIST_FILE_PATH=$(ls ${PWD}/dist/*.whl)" >> $BASH_ENV
      - run:
          name: Tox
          command: |
            python -m pip install --quiet --upgrade pip setuptools wheel
            python -m pip install tox
            python -m tox --installpkg="${DIST_FILE_PATH}"
  tox_linux_cpython_3_8_sdist:
    docker:
      - image: python:3.8
    environment:
      TOXENV: py38
    steps:
      - checkout
      - attach_workspace:
          at: .
      - run:
          name: Select distribution file
          command: |
            ls ${PWD}/dist/*
            echo "export DIST_FILE_PATH=$(ls ${PWD}/dist/*.tar.gz)" >> $BASH_ENV
      - run:
          name: Tox
          command: |
            python -m pip install --quiet --upgrade pip setuptools wheel
            python -m pip install tox
            python -m tox --installpkg="${DIST_FILE_PATH}"
  tox_linux_cpython_3_8_bdist:
    docker:
      - image: python:3.8
    environment:
      TOXENV: py38
    steps:
      - checkout
      - attach_workspace:
          at: .
      - run:
          name: Select distribution file
          command: |
            ls ${PWD}/dist/*
            echo "export DIST_FILE_PATH=$(ls ${PWD}/dist/*.whl)" >> $BASH_ENV
      - run:
          name: Tox
          command: |
            python -m pip install --quiet --upgrade pip setuptools wheel
            python -m pip install tox
            python -m tox --installpkg="${DIST_FILE_PATH}"
  tox_macos_cpython_3_8_bdist:
    macos:
      xcode: "10.0.0"
    environment:
      TOXENV: py38
      PYENV_ROOT: ~/.ciborg/pyenv
    steps:
      - checkout
      - attach_workspace:
          at: .
      - run:
          name: Select distribution file
          command: |
            ls ${PWD}/dist/*
            echo "export DIST_FILE_PATH=$(ls ${PWD}/dist/*.whl)" >> $BASH_ENV
      - run:
          name: Install pyenv support libraries
          command: |
            brew install readline xz
      - run:
          name: Install pyenv
          command: |
            curl https://pyenv.run | bash
      - run:
          name: pyenv install CPython 3.8
          command: |
            CFLAGS="-I$(brew --prefix openssl)/include" LDFLAGS="-L$(brew --prefix openssl)/lib" pyenv install -v 3.8.3
      - run:
          name: Tox
          command: |
            python -m pip install --quiet --upgrade pip setuptools wheel
            python -m pip install tox
            python -m tox --installpkg="${DIST_FILE_PATH}"
  tox_windows_cpython_3_8_bdist:
    executor:
      name: windows/default
      shell: bash
    environment:
      TOXENV: py38
    steps:
      - checkout
      - attach_workspace:
          at: .
      - run:
          name: Select distribution file
          command: |
            ls ${PWD}/dist/*
            echo "export DIST_FILE_PATH=$(ls ${PWD}/dist/*.whl)" >> $BASH_ENV
      - run:
          name: Tox
          command: |
            python -m pip install --quiet --upgrade pip setuptools wheel
            python -m pip install tox
            python -m tox --installpkg="${DIST_FILE_PATH}"

workflows:
  version: 2
  all:
    jobs:
      - sdist
      - bdist
      - tox_typehints_linux_cpython_3_8
      - tox_linux_cpython_3_6_bdist:
          requires:
            - bdist
      - tox_linux_cpython_3_8_sdist:
          requires:
            - sdist
      - tox_linux_cpython_3_8_bdist:
          requires:
            - bdist
      - tox_macos_cpython_3_8_bdist:
          requires:
            - bdist
      - tox_windows_cpython_3_8_bdist:
          requires:
            - bdist
