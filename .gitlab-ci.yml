workflow:
  rules:
    - if: $CI_COMMIT_BRANCH =~ /^master$/
    - if: $CI_COMMIT_TAG =~ /^v/
    - if: $CI_EXTERNAL_PULL_REQUEST_IID != null
    - if: $CI_MERGE_REQUEST_ID != null
    - if: $CI != null # always
      when: never
sdist:
  stage: build
  image: python:3.8
  script:
    - python -m pip install --quiet --upgrade pip
    - python -m pip install --quiet --upgrade pep517
    - python -m pep517.build --source --out-dir dist/ .
  artifacts:
    paths:
      - dist/*
bdist:
  stage: build
  image: python:3.8
  script:
    - python -m pip install --quiet --upgrade pip
    - python -m pip install --quiet --upgrade pep517
    - python -m pep517.build --binary --out-dir dist/ .
  artifacts:
    paths:
      - dist/*
tox_typehints_linux_cpython_3_8:
  stage: test
  image: python:3.8
  script:
    - python -m pip install --quiet --upgrade pip setuptools wheel
    - python -m pip install tox
    - python -m tox
  variables:
    TOXENV: typehints
tox_linux_cpython_3_6_bdist:
  stage: test
  image: python:3.6
  needs:
    - bdist
  script:
    - python -m pip install --quiet --upgrade pip setuptools wheel
    - python -m pip install tox
    - python -m tox
  variables:
    TOXENV: py36
